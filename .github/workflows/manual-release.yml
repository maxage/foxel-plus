name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

jobs:
  manual-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Build all plugins
      run: |
        echo "ðŸ”¨ Building all plugins..."
        for plugin in foxel-*/; do
          if [ -f "$plugin/package.json" ]; then
            echo "Building $plugin..."
            cd "$plugin"
            npm ci
            npm run build
            if [ -f "dist/plugin.js" ]; then
              echo "âœ… Successfully built $plugin"
              echo "ðŸ“Š File size: $(du -h dist/plugin.js | cut -f1)"
            else
              echo "âŒ Build failed for $plugin"
              exit 1
            fi
            cd ..
          fi
        done
        
    - name: Create release files
      run: |
        echo "ðŸ“¦ Creating release files..."
        mkdir -p release
        
        # Copy plugin files
        for plugin in foxel-*/; do
          if [ -f "$plugin/dist/plugin.js" ]; then
            plugin_name=$(basename "$plugin")
            cp "$plugin/dist/plugin.js" "release/${plugin_name}.js"
            echo "âœ… Packaged $plugin_name"
          fi
        done
        
        # Create release notes
        cat > release/RELEASE_NOTES.md << 'EOF'
        # ðŸŽ‰ Foxel Plus å‘å¸ƒè¯´æ˜Ž
        
        ## ðŸ“¦ åŒ…å«çš„æ’ä»¶
        
        EOF
        
        # Add plugin info to release notes
        for plugin in foxel-*/; do
          if [ -f "$plugin/package.json" ]; then
            plugin_name=$(basename "$plugin")
            plugin_version=$(grep '"version"' "$plugin/package.json" | cut -d'"' -f4)
            plugin_desc=$(grep '"description"' "$plugin/package.json" | cut -d'"' -f4)
            file_size=$(du -h "release/${plugin_name}.js" | cut -f1)
            
            echo "### ðŸ–¼ï¸ ${plugin_name} (v${plugin_version})" >> release/RELEASE_NOTES.md
            echo "" >> release/RELEASE_NOTES.md
            echo "**æè¿°**: ${plugin_desc}" >> release/RELEASE_NOTES.md
            echo "**æ–‡ä»¶å¤§å°**: ${file_size}" >> release/RELEASE_NOTES.md
            echo "**æ”¯æŒæ ¼å¼**: JPG, PNG, GIF, BMP, WebP, SVG, ICO, TIFF" >> release/RELEASE_NOTES.md
            echo "" >> release/RELEASE_NOTES.md
            echo "#### ä¸»è¦åŠŸèƒ½" >> release/RELEASE_NOTES.md
            echo "- ðŸ” æ™ºèƒ½ç¼©æ”¾ï¼ˆ10%-500%ï¼‰" >> release/RELEASE_NOTES.md
            echo "- ðŸ–±ï¸ æ‹–æ‹½ç§»åŠ¨" >> release/RELEASE_NOTES.md
            echo "- ðŸŽ›ï¸ å·¥å…·æ æŽ§åˆ¶" >> release/RELEASE_NOTES.md
            echo "- ðŸŒ™ æ·±è‰²ä¸»é¢˜" >> release/RELEASE_NOTES.md
            echo "- ðŸ“± å“åº”å¼è®¾è®¡" >> release/RELEASE_NOTES.md
            echo "" >> release/RELEASE_NOTES.md
            echo "#### å®‰è£…æ–¹æ³•" >> release/RELEASE_NOTES.md
            echo "1. ä¸‹è½½ \`${plugin_name}.js\` æ–‡ä»¶" >> release/RELEASE_NOTES.md
            echo "2. å°†æ–‡ä»¶å¤åˆ¶åˆ° Foxel çš„ \`web/public/plugins/\` ç›®å½•" >> release/RELEASE_NOTES.md
            echo "3. åœ¨ Foxel çš„"åº”ç”¨"é¡µé¢å®‰è£…æ’ä»¶" >> release/RELEASE_NOTES.md
            echo "4. é€‰æ‹©å¯¹åº”æ–‡ä»¶ç±»åž‹å³å¯ä½¿ç”¨" >> release/RELEASE_NOTES.md
            echo "" >> release/RELEASE_NOTES.md
          fi
        done
        
        echo "ðŸ“‹ Release files created:"
        ls -la release/
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.version }}
        name: Foxel Plus ${{ inputs.version }}
        files: |
          release/*.js
          release/RELEASE_NOTES.md
        body_path: release/RELEASE_NOTES.md
        generate_release_notes: true
        draft: false
        prerelease: ${{ inputs.prerelease }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
