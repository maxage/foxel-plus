name: Auto Release Plugin

on:
  push:
    paths:
      - 'foxel-image-viewer/**'
      - 'foxel-image-viewer.js'
    branches:
      - main
  workflow_dispatch:

jobs:
  auto-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Get version from package.json
      id: get-version
      run: |
        cd foxel-image-viewer
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Plugin version: $VERSION"
        
    - name: Check if release exists
      id: check-release
      run: |
        TAG=${{ steps.get-version.outputs.tag }}
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Tag $TAG already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "ðŸ†• Tag $TAG does not exist, will create release"
        fi
        
    - name: Build plugin
      if: steps.check-release.outputs.exists == 'false'
      run: |
        cd foxel-image-viewer
        npm ci
        npm run build
        echo "ðŸ”¨ Plugin built successfully"
        
    - name: Prepare release files
      if: steps.check-release.outputs.exists == 'false'
      run: |
        mkdir -p release
        cp foxel-image-viewer/dist/plugin.js release/foxel-image-viewer.js
        
        # Get file size
        FILE_SIZE=$(du -h release/foxel-image-viewer.js | cut -f1)
        echo "ðŸ“ Plugin file size: $FILE_SIZE"
        
        # Create release notes
        cat > release/RELEASE_NOTES.md << EOF
        # ðŸŽ‰ Foxel Image Viewer v${{ steps.get-version.outputs.version }}
        
        ## ðŸ“¦ æ’ä»¶ä¿¡æ¯
        
        **æ–‡ä»¶å¤§å°**: $FILE_SIZE  
        **æ”¯æŒæ ¼å¼**: JPG, PNG, GIF, BMP, WebP, SVG, ICO, TIFF  
        **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        ## âœ¨ ä¸»è¦åŠŸèƒ½
        
        - ðŸ” **æ™ºèƒ½ç¼©æ”¾** - æ”¯æŒ 10%-500% ç¼©æ”¾èŒƒå›´
        - ðŸ–±ï¸ **æ‹–æ‹½ç§»åŠ¨** - æµç•…çš„å›¾ç‰‡æ‹–æ‹½ä½“éªŒ
        - ðŸŽ›ï¸ **å·¥å…·æ æŽ§åˆ¶** - ç›´è§‚çš„æ“ä½œç•Œé¢
        - ðŸŒ™ **æ·±è‰²ä¸»é¢˜** - çŽ°ä»£åŒ–çš„è§†è§‰è®¾è®¡
        - ðŸ“± **å“åº”å¼è®¾è®¡** - é€‚é…ä¸åŒå±å¹•å°ºå¯¸
        
        ## ðŸš€ å®‰è£…æ–¹æ³•
        
        1. ä¸‹è½½ \`foxel-image-viewer.js\` æ–‡ä»¶
        2. åœ¨ Foxel çš„"åº”ç”¨"é¡µé¢æ·»åŠ æ’ä»¶
        3. è¾“å…¥æ’ä»¶ URL: \`https://github.com/maxage/foxel-plus/releases/latest/download/foxel-image-viewer.js\`
        4. å®‰è£…å®ŒæˆåŽå³å¯åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æŸ¥çœ‹å›¾ç‰‡
        
        ## ðŸ”§ æŠ€æœ¯ç‰¹æ€§
        
        - **å®Œå…¨è‡ªåŒ…å«** - å•æ–‡ä»¶è¾“å‡ºï¼Œæ— å¤–éƒ¨ä¾èµ–
        - **ç±»åž‹å®‰å…¨** - åŸºäºŽ TypeScript å¼€å‘
        - **çŽ°ä»£åŒ– UI** - ä½¿ç”¨ React 19 æž„å»º
        - **é«˜æ€§èƒ½** - ESBuild ä¼˜åŒ–æž„å»º
        - **å³æ’å³ç”¨** - ç¬¦åˆ Foxel æ’ä»¶è§„èŒƒ
        
        ## ðŸ“ æ›´æ–°æ—¥å¿—
        
        æœ¬æ¬¡æ›´æ–°åŒ…å«ä»¥ä¸‹æ”¹è¿›ï¼š
        - ä¼˜åŒ–äº†æž„å»ºé…ç½®ï¼Œä¸¥æ ¼æŒ‰ç…§ Foxel å®˜æ–¹æŒ‡å—
        - æ”¹è¿›äº†æ’ä»¶å…ƒæ•°æ®è§£æž
        - æå‡äº†æ•´ä½“æ€§èƒ½å’Œç¨³å®šæ€§
        
        ---
        
        **è‡ªåŠ¨æž„å»º**: æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ
        EOF
        
        echo "ðŸ“‹ Release files prepared:"
        ls -la release/
        
    - name: Create Git Tag
      if: steps.check-release.outputs.exists == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a ${{ steps.get-version.outputs.tag }} -m "Release ${{ steps.get-version.outputs.tag }}"
        git push origin ${{ steps.get-version.outputs.tag }}
        echo "ðŸ·ï¸ Created and pushed tag: ${{ steps.get-version.outputs.tag }}"
        
    - name: Create GitHub Release
      if: steps.check-release.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get-version.outputs.tag }}
        name: Foxel Image Viewer ${{ steps.get-version.outputs.tag }}
        files: |
          release/foxel-image-viewer.js
          release/RELEASE_NOTES.md
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update root plugin file
      if: steps.check-release.outputs.exists == 'false'
      run: |
        cp foxel-image-viewer/dist/plugin.js foxel-image-viewer.js
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add foxel-image-viewer.js
        git commit -m "chore: update root plugin file for v${{ steps.get-version.outputs.version }}"
        git push origin main
        echo "ðŸ“ Updated root plugin file"
        
    - name: Skip release
      if: steps.check-release.outputs.exists == 'true'
      run: |
        echo "â­ï¸ Release ${{ steps.get-version.outputs.tag }} already exists, skipping"
