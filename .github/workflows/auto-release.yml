name: Auto Release Plugin

on:
  push:
    paths:
      - 'foxel-*/**'
      - 'foxel-*.js'
    branches:
      - main
  workflow_dispatch:

jobs:
  auto-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Detect changed plugins
      id: detect-plugins
      run: |
        echo "ðŸ” Detecting changed plugins..."
        CHANGED_PLUGINS=""
        
        # Check for changes in plugin directories
        for plugin_dir in foxel-*/; do
          if [ -d "$plugin_dir" ]; then
            plugin_name=$(basename "$plugin_dir")
            if git diff --name-only HEAD~1 HEAD | grep -q "^$plugin_dir"; then
              CHANGED_PLUGINS="$CHANGED_PLUGINS $plugin_name"
              echo "ðŸ“¦ Changed plugin: $plugin_name"
            fi
          fi
        done
        
        # Check for changes in root plugin files
        for plugin_file in foxel-*.js; do
          if [ -f "$plugin_file" ]; then
            plugin_name=$(basename "$plugin_file" .js)
            if git diff --name-only HEAD~1 HEAD | grep -q "^$plugin_file"; then
              CHANGED_PLUGINS="$CHANGED_PLUGINS $plugin_name"
              echo "ðŸ“¦ Changed plugin file: $plugin_name"
            fi
          fi
        done
        
        if [ -z "$CHANGED_PLUGINS" ]; then
          echo "No plugin changes detected"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "plugins=$CHANGED_PLUGINS" >> $GITHUB_OUTPUT
        fi
        
    - name: Get version from changed plugins
      id: get-version
      if: steps.detect-plugins.outputs.changed == 'true'
      run: |
        echo "ðŸ“¦ Getting version from changed plugins..."
        VERSION="1.0.0"  # Default version
        
        # Get version from first changed plugin
        for plugin in ${{ steps.detect-plugins.outputs.plugins }}; do
          if [ -d "$plugin" ] && [ -f "$plugin/package.json" ]; then
            VERSION=$(node -p "require('./$plugin/package.json').version")
            echo "ðŸ“¦ Plugin $plugin version: $VERSION"
            break
          fi
        done
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        
    - name: Check if release exists
      id: check-release
      run: |
        TAG=${{ steps.get-version.outputs.tag }}
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Tag $TAG already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "ðŸ†• Tag $TAG does not exist, will create release"
        fi
        
    - name: Build changed plugins
      if: steps.check-release.outputs.exists == 'false'
      run: |
        echo "ðŸ”¨ Building changed plugins..."
        
        for plugin in ${{ steps.detect-plugins.outputs.plugins }}; do
          if [ -d "$plugin" ] && [ -f "$plugin/package.json" ]; then
            echo "ðŸ“¦ Building plugin: $plugin"
            cd "$plugin"
            npm ci
            npm run build
            cd ..
            echo "âœ… Plugin $plugin built successfully"
          fi
        done
        
    - name: Prepare release files
      if: steps.check-release.outputs.exists == 'false'
      run: |
        mkdir -p release
        echo "ðŸ“¦ Preparing release files for changed plugins..."
        
        # Copy plugin files
        for plugin in ${{ steps.detect-plugins.outputs.plugins }}; do
          if [ -d "$plugin" ] && [ -f "$plugin/dist/plugin.js" ]; then
            cp "$plugin/dist/plugin.js" "release/$plugin.js"
            FILE_SIZE=$(du -h "release/$plugin.js" | cut -f1)
            echo "ðŸ“ Plugin $plugin file size: $FILE_SIZE"
          fi
        done
        
        # Create release notes
        cat > release/RELEASE_NOTES.md << EOF
        # ðŸŽ‰ Foxel Plus Plugins v${{ steps.get-version.outputs.version }}
        
        ## ðŸ“¦ åŒ…å«çš„æ’ä»¶
        
        EOF
        
        # Add plugin information
        for plugin in ${{ steps.detect-plugins.outputs.plugins }}; do
          if [ -d "$plugin" ] && [ -f "$plugin/package.json" ]; then
            PLUGIN_NAME=$(node -p "require('./$plugin/package.json').name")
            PLUGIN_DESC=$(node -p "require('./$plugin/package.json').description")
            PLUGIN_AUTHOR=$(node -p "require('./$plugin/package.json').author")
            PLUGIN_VERSION=$(node -p "require('./$plugin/package.json').version")
            FILE_SIZE=$(du -h "release/$plugin.js" | cut -f1)
            
            cat >> release/RELEASE_NOTES.md << EOF
        ### ðŸ”Œ $PLUGIN_NAME (v$PLUGIN_VERSION)
        
        **æè¿°**: $PLUGIN_DESC  
        **ä½œè€…**: $PLUGIN_AUTHOR  
        **æ–‡ä»¶å¤§å°**: $FILE_SIZE  
        **ä¸‹è½½**: [\`$plugin.js\`](https://github.com/maxage/foxel-plus/releases/latest/download/$plugin.js)
        
        EOF
          fi
        done
        
        cat >> release/RELEASE_NOTES.md << EOF
        
        ## ðŸš€ å®‰è£…æ–¹æ³•
        
        1. ä¸‹è½½æ‰€éœ€çš„æ’ä»¶æ–‡ä»¶
        2. åœ¨ Foxel çš„"åº”ç”¨"é¡µé¢æ·»åŠ æ’ä»¶
        3. è¾“å…¥å¯¹åº”çš„æ’ä»¶ URL
        4. å®‰è£…å®ŒæˆåŽå³å¯ä½¿ç”¨
        
        ## ðŸ”§ æŠ€æœ¯ç‰¹æ€§
        
        - **å®Œå…¨è‡ªåŒ…å«** - å•æ–‡ä»¶è¾“å‡ºï¼Œæ— å¤–éƒ¨ä¾èµ–
        - **ç±»åž‹å®‰å…¨** - åŸºäºŽ TypeScript å¼€å‘
        - **çŽ°ä»£åŒ– UI** - ä½¿ç”¨ React 19 æž„å»º
        - **é«˜æ€§èƒ½** - ESBuild ä¼˜åŒ–æž„å»º
        - **å³æ’å³ç”¨** - ç¬¦åˆ Foxel æ’ä»¶è§„èŒƒ
        
        ## ðŸ“ æ›´æ–°æ—¥å¿—
        
        æœ¬æ¬¡æ›´æ–°åŒ…å«ä»¥ä¸‹æ”¹è¿›ï¼š
        - æ”¯æŒå¤šæ’ä»¶ä»“åº“ç»“æž„
        - ä¼˜åŒ–äº†æž„å»ºé…ç½®ï¼Œä¸¥æ ¼æŒ‰ç…§ Foxel å®˜æ–¹æŒ‡å—
        - æ”¹è¿›äº†æ’ä»¶å…ƒæ•°æ®è§£æž
        - æå‡äº†æ•´ä½“æ€§èƒ½å’Œç¨³å®šæ€§
        
        ---
        
        **è‡ªåŠ¨æž„å»º**: æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ  
        **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        EOF
        
        echo "ðŸ“‹ Release files prepared:"
        ls -la release/
        
    - name: Create Git Tag
      if: steps.check-release.outputs.exists == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a ${{ steps.get-version.outputs.tag }} -m "Release ${{ steps.get-version.outputs.tag }}"
        git push origin ${{ steps.get-version.outputs.tag }}
        echo "ðŸ·ï¸ Created and pushed tag: ${{ steps.get-version.outputs.tag }}"
        
    - name: Create GitHub Release
      if: steps.check-release.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get-version.outputs.tag }}
        name: Foxel Plus Plugins ${{ steps.get-version.outputs.tag }}
        files: |
          release/*.js
          release/RELEASE_NOTES.md
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update root plugin files
      if: steps.check-release.outputs.exists == 'false'
      run: |
        echo "ðŸ“ Updating root plugin files..."
        
        # Update root plugin files for changed plugins
        for plugin in ${{ steps.detect-plugins.outputs.plugins }}; do
          if [ -d "$plugin" ] && [ -f "$plugin/dist/plugin.js" ]; then
            cp "$plugin/dist/plugin.js" "$plugin.js"
            echo "ðŸ“ Updated root file: $plugin.js"
          fi
        done
        
        # Commit changes
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add foxel-*.js
        git commit -m "chore: update root plugin files for v${{ steps.get-version.outputs.version }}"
        git push origin main
        echo "ðŸ“ Updated root plugin files"
        
    - name: Skip release
      if: steps.check-release.outputs.exists == 'true'
      run: |
        echo "â­ï¸ Release ${{ steps.get-version.outputs.tag }} already exists, skipping"
