name: Test Release

on:
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Test version (e.g., v1.0.0-test)'
        required: true
        default: 'v1.0.0-test'

jobs:
  test-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Build plugin
      run: |
        cd foxel-image-viewer
        npm ci
        npm run build
        echo "🔨 Plugin built successfully"
        
    - name: Prepare test release files
      run: |
        mkdir -p release
        cp foxel-image-viewer/dist/plugin.js release/foxel-image-viewer.js
        
        # Get file size
        FILE_SIZE=$(du -h release/foxel-image-viewer.js | cut -f1)
        echo "📏 Plugin file size: $FILE_SIZE"
        
        # Create test release notes
        cat > release/RELEASE_NOTES.md << EOF
        # 🧪 Test Release - Foxel Image Viewer ${{ inputs.test_version }}
        
        ## ⚠️ 注意
        这是一个测试版本，用于验证自动构建和发布流程。
        
        ## 📦 插件信息
        
        **文件大小**: $FILE_SIZE  
        **支持格式**: JPG, PNG, GIF, BMP, WebP, SVG, ICO, TIFF  
        **构建时间**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        ## 🔧 测试内容
        
        - ✅ 插件构建成功
        - ✅ 文件大小正常
        - ✅ 元数据完整
        - ✅ 符合 Foxel 规范
        
        ## 🚀 安装方法
        
        1. 下载 \`foxel-image-viewer.js\` 文件
        2. 在 Foxel 的"应用"页面添加插件
        3. 输入插件 URL: \`https://github.com/maxage/foxel-plus/releases/download/${{ inputs.test_version }}/foxel-image-viewer.js\`
        4. 安装并测试功能
        
        ---
        
        **测试构建**: 此版本用于测试自动构建流程
        EOF
        
        echo "📋 Test release files prepared:"
        ls -la release/
        
    - name: Create Test Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.test_version }}
        name: Test Release - Foxel Image Viewer ${{ inputs.test_version }}
        files: |
          release/foxel-image-viewer.js
          release/RELEASE_NOTES.md
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Test Results
      run: |
        echo "✅ Test release created successfully!"
        echo "🏷️ Tag: ${{ inputs.test_version }}"
        echo "📁 Files: foxel-image-viewer.js, RELEASE_NOTES.md"
        echo "🔗 URL: https://github.com/maxage/foxel-plus/releases/tag/${{ inputs.test_version }}"