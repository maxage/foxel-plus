name: Test Release

on:
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Test version (e.g., v1.0.0-test)'
        required: true
        default: 'v1.0.0-test'

jobs:
  test-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Build plugin
      run: |
        cd foxel-image-viewer
        npm ci
        npm run build
        echo "ðŸ”¨ Plugin built successfully"
        
    - name: Prepare test release files
      run: |
        mkdir -p release
        cp foxel-image-viewer/dist/plugin.js release/foxel-image-viewer.js
        
        # Get file size
        FILE_SIZE=$(du -h release/foxel-image-viewer.js | cut -f1)
        echo "ðŸ“ Plugin file size: $FILE_SIZE"
        
        # Create test release notes
        cat > release/RELEASE_NOTES.md << EOF
        # ðŸ§ª Test Release - Foxel Image Viewer ${{ inputs.test_version }}
        
        ## âš ï¸ æ³¨æ„
        è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬ï¼Œç”¨äºŽéªŒè¯è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒæµç¨‹ã€‚
        
        ## ðŸ“¦ æ’ä»¶ä¿¡æ¯
        
        **æ–‡ä»¶å¤§å°**: $FILE_SIZE  
        **æ”¯æŒæ ¼å¼**: JPG, PNG, GIF, BMP, WebP, SVG, ICO, TIFF  
        **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        ## ðŸ”§ æµ‹è¯•å†…å®¹
        
        - âœ… æ’ä»¶æž„å»ºæˆåŠŸ
        - âœ… æ–‡ä»¶å¤§å°æ­£å¸¸
        - âœ… å…ƒæ•°æ®å®Œæ•´
        - âœ… ç¬¦åˆ Foxel è§„èŒƒ
        
        ## ðŸš€ å®‰è£…æ–¹æ³•
        
        1. ä¸‹è½½ \`foxel-image-viewer.js\` æ–‡ä»¶
        2. åœ¨ Foxel çš„"åº”ç”¨"é¡µé¢æ·»åŠ æ’ä»¶
        3. è¾“å…¥æ’ä»¶ URL: \`https://github.com/maxage/foxel-plus/releases/download/${{ inputs.test_version }}/foxel-image-viewer.js\`
        4. å®‰è£…å¹¶æµ‹è¯•åŠŸèƒ½
        
        ---
        
        **æµ‹è¯•æž„å»º**: æ­¤ç‰ˆæœ¬ç”¨äºŽæµ‹è¯•è‡ªåŠ¨æž„å»ºæµç¨‹
        EOF
        
        echo "ðŸ“‹ Test release files prepared:"
        ls -la release/
        
    - name: Create Test Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.test_version }}
        name: Test Release - Foxel Image Viewer ${{ inputs.test_version }}
        files: |
          release/foxel-image-viewer.js
          release/RELEASE_NOTES.md
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Test Results
      run: |
        echo "âœ… Test release created successfully!"
        echo "ðŸ·ï¸ Tag: ${{ inputs.test_version }}"
        echo "ðŸ“ Files: foxel-image-viewer.js, RELEASE_NOTES.md"
        echo "ðŸ”— URL: https://github.com/maxage/foxel-plus/releases/tag/${{ inputs.test_version }}"