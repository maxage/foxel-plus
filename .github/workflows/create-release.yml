name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update plugin version
      run: |
        echo "ðŸ“¦ Updating plugin version to ${{ inputs.version }}"
        
        # æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
        VERSION="${{ inputs.version }}"
        if [[ $VERSION == v* ]]; then
          VERSION=${VERSION#v}
        fi
        
        echo "ðŸ“ Version: $VERSION"
        
        # æ›´æ–°æ‰€æœ‰æ’ä»¶çš„ package.json
        for plugin_dir in foxel-*/; do
          if [ -d "$plugin_dir" ] && [ -f "$plugin_dir/package.json" ]; then
            echo "ðŸ”„ Updating $plugin_dir package.json"
            cd "$plugin_dir"
            
            # ä½¿ç”¨ npm version å‘½ä»¤æ›´æ–°ç‰ˆæœ¬å·
            npm version "$VERSION" --no-git-tag-version
            
            echo "âœ… Updated $plugin_dir to version $VERSION"
            cd ..
          fi
        done
        
    - name: Build all plugins
      run: |
        echo "ðŸ”¨ Building all plugins..."
        
        # æž„å»ºæ‰€æœ‰æ’ä»¶
        for plugin_dir in foxel-*/; do
          if [ -d "$plugin_dir" ] && [ -f "$plugin_dir/package.json" ]; then
            echo "ðŸ“¦ Building plugin: $plugin_dir"
            cd "$plugin_dir"
            npm ci
            npm run build
            cd ..
            echo "âœ… Plugin $plugin_dir built successfully"
          fi
        done
        
    - name: Prepare release files
      run: |
        mkdir -p release
        
        # å¤åˆ¶æ‰€æœ‰æ’ä»¶çš„æž„å»ºæ–‡ä»¶
        for plugin_dir in foxel-*/; do
          if [ -d "$plugin_dir" ] && [ -f "$plugin_dir/dist/plugin.js" ]; then
            plugin_name=$(basename "$plugin_dir")
            echo "ðŸ“ Copying $plugin_name/dist/plugin.js to release/"
            cp "$plugin_dir/dist/plugin.js" "release/$plugin_name.js"
          fi
        done
        
        # èŽ·å–å®žé™…ç‰ˆæœ¬å·
        VERSION="${{ inputs.version }}"
        if [[ $VERSION == v* ]]; then
          VERSION=${VERSION#v}
        fi
        
        # Create release notes
        cat > release/RELEASE_NOTES.md << EOF
        # ðŸŽ‰ Foxel Plus å‘å¸ƒè¯´æ˜Ž
        
        ## ðŸ“¦ åŒ…å«çš„æ’ä»¶
        
        EOF
        
        # Add plugin information dynamically
        for plugin_dir in foxel-*/; do
          if [ -d "$plugin_dir" ] && [ -f "$plugin_dir/package.json" ]; then
            plugin_name=$(basename "$plugin_dir")
            PLUGIN_NAME=$(node -p "require('./$plugin_dir/package.json').name")
            PLUGIN_DESCRIPTION=$(node -p "require('./$plugin_dir/package.json').description")
            PLUGIN_AUTHOR=$(node -p "require('./$plugin_dir/package.json').author")
            FILE_SIZE=$(du -h "release/$plugin_name.js" | cut -f1)
            
            # æ ¹æ®æ’ä»¶ç±»åž‹æ·»åŠ ä¸åŒçš„åŠŸèƒ½æè¿°
            if [[ "$plugin_name" == *"image"* ]]; then
              PLUGIN_ICON="ðŸ–¼ï¸"
              PLUGIN_FEATURES="- ðŸ” æ™ºèƒ½ç¼©æ”¾ï¼ˆ10%-500%ï¼‰
        - ðŸ–±ï¸ æ‹–æ‹½ç§»åŠ¨
        - ðŸ”„ æ—‹è½¬å’Œç¿»è½¬
        - â¤¢ å…¨å±æ¨¡å¼
        - â„¹ï¸ å›¾ç‰‡ä¿¡æ¯æ˜¾ç¤º
        - âŒ¨ï¸ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        - ðŸŽ›ï¸ æ™ºèƒ½å·¥å…·æ 
        - ðŸŒ™ æ·±è‰²ä¸»é¢˜
        - ðŸ“± å“åº”å¼è®¾è®¡"
              SUPPORTED_FORMATS="JPG, PNG, GIF, BMP, WebP, SVG, ICO, TIFF"
            elif [[ "$plugin_name" == *"code"* ]]; then
              PLUGIN_ICON="ðŸ’»"
              PLUGIN_FEATURES="- ðŸŽ¨ è¯­æ³•é«˜äº®ï¼ˆ50+ è¯­è¨€ï¼‰
        - ðŸŒˆ 5 ç§ä¸»é¢˜åˆ‡æ¢
        - ðŸ” å®žæ—¶æœç´¢åŠŸèƒ½
        - ðŸ“ ä»£ç æŠ˜å å’Œè¡Œå·
        - âš™ï¸ å­—ä½“å¤§å°è°ƒèŠ‚
        - ðŸ“‹ å¤åˆ¶å’Œä¸‹è½½åŠŸèƒ½
        - âŒ¨ï¸ å®Œæ•´é”®ç›˜å¿«æ·é”®
        - ðŸŽ›ï¸ æ™ºèƒ½å·¥å…·æ 
        - ðŸ“± å“åº”å¼è®¾è®¡"
              SUPPORTED_FORMATS="JS/TS, HTML/CSS, Python, Java, C/C++, Go, Rust, ç­‰ 50+ æ ¼å¼"
            elif [[ "$plugin_name" == *"ebook"* ]]; then
              PLUGIN_ICON="ðŸ“š"
              PLUGIN_FEATURES="- ðŸ“– æ»šåŠ¨/åˆ†é¡µæ¨¡å¼åˆ‡æ¢
        - ðŸ—‚ï¸ æ™ºèƒ½ç›®å½•ä¸Žç« èŠ‚å¯¼èˆª
        - ðŸŽ¨ ä¸»é¢˜ã€å­—å·ã€è¡Œè·è‡ªå®šä¹‰
        - ðŸ” å…¨æ–‡æœç´¢ä¸Žé«˜äº®
        - ðŸ“Œ ä¹¦ç­¾ä¸Žé˜…è¯»è¿›åº¦æŒä¹…åŒ–
        - ðŸ“¥ EPUB èµ„æºå†…è”åŠ è½½
        - ðŸ“„ æµè§ˆå™¨å†…ç½® PDF æ’­æ”¾
        - âŒ¨ï¸ å¿«æ·é”®å¯¼èˆª"
              SUPPORTED_FORMATS="TXT, Markdown, HTML, EPUB, PDF"
            else
              PLUGIN_ICON="ðŸ”Œ"
              PLUGIN_FEATURES="- ðŸŽ¯ å³æ’å³ç”¨
        - ðŸ”§ å®Œå…¨è‡ªåŒ…å«
        - ðŸŽ¨ çŽ°ä»£åŒ– UI
        - ðŸ“± å“åº”å¼è®¾è®¡"
              SUPPORTED_FORMATS="å¤šç§æ–‡ä»¶æ ¼å¼"
            fi
            
            cat >> release/RELEASE_NOTES.md << EOF
        ### $PLUGIN_ICON $PLUGIN_NAME (v$VERSION)
        
        **æè¿°**: $PLUGIN_DESCRIPTION  
        **ä½œè€…**: $PLUGIN_AUTHOR  
        **æ–‡ä»¶å¤§å°**: $FILE_SIZE  
        **æ”¯æŒæ ¼å¼**: $SUPPORTED_FORMATS
        
        #### ä¸»è¦åŠŸèƒ½
        $PLUGIN_FEATURES
        
        #### å®‰è£…æ–¹æ³•
        1. ä¸‹è½½ \`$plugin_name.js\` æ–‡ä»¶
        2. å°†æ–‡ä»¶å¤åˆ¶åˆ° Foxel çš„ \`web/public/plugins/\` ç›®å½•
        3. åœ¨ Foxel çš„"åº”ç”¨"é¡µé¢å®‰è£…æ’ä»¶
        4. é€‰æ‹©å¯¹åº”æ–‡ä»¶ç±»åž‹å³å¯ä½¿ç”¨
        
        #### æŠ€æœ¯ç‰¹æ€§
        - **å®Œå…¨è‡ªåŒ…å«** - å•æ–‡ä»¶è¾“å‡ºï¼Œæ— å¤–éƒ¨ä¾èµ–
        - **ç±»åž‹å®‰å…¨** - åŸºäºŽ TypeScript å¼€å‘
        - **çŽ°ä»£åŒ– UI** - ä½¿ç”¨ React 18 æž„å»º
        - **é«˜æ€§èƒ½** - ESBuild ä¼˜åŒ–æž„å»º
        - **å³æ’å³ç”¨** - ç¬¦åˆ Foxel æ’ä»¶è§„èŒƒ
        
        EOF
          fi
        done
        
        # Add common sections
        cat >> release/RELEASE_NOTES.md << EOF
        
        ## ðŸš€ å®‰è£…æ–¹æ³•
        
        1. ä¸‹è½½æ‰€éœ€çš„æ’ä»¶æ–‡ä»¶
        2. åœ¨ Foxel çš„"åº”ç”¨"é¡µé¢æ·»åŠ æ’ä»¶
        3. è¾“å…¥å¯¹åº”çš„æ’ä»¶ URL
        4. å®‰è£…å®ŒæˆåŽå³å¯ä½¿ç”¨
        
        ## ðŸ”§ æŠ€æœ¯ç‰¹æ€§
        
        - **å®Œå…¨è‡ªåŒ…å«** - å•æ–‡ä»¶è¾“å‡ºï¼Œæ— å¤–éƒ¨ä¾èµ–
        - **ç±»åž‹å®‰å…¨** - åŸºäºŽ TypeScript å¼€å‘
        - **çŽ°ä»£åŒ– UI** - ä½¿ç”¨ React 18 æž„å»º
        - **é«˜æ€§èƒ½** - ESBuild ä¼˜åŒ–æž„å»º
        - **å³æ’å³ç”¨** - ç¬¦åˆ Foxel æ’ä»¶è§„èŒƒ
        
        ## ðŸ“ æ›´æ–°æ—¥å¿—
        
        - ç‰ˆæœ¬ $VERSION æ›´æ–°
        - ä¿®å¤äº† TypeScript ç±»åž‹é”™è¯¯
        - ä¼˜åŒ–äº†æ’ä»¶æž„å»ºæµç¨‹
        - å¢žå¼ºäº†é”™è¯¯å¤„ç†æœºåˆ¶
        - æ”¹è¿›äº†ç”¨æˆ·ä½“éªŒ
        
        ---
        
        **è‡ªåŠ¨æž„å»º**: æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ  
        **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        EOF
        
        echo "ðŸ“‹ Release files prepared:"
        ls -la release/
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.version }}
        name: Foxel Plus Plugins ${{ inputs.version }}
        files: release/*.js
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: ${{ inputs.prerelease }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update root plugin files
      run: |
        echo "ðŸ“ Updating root plugin files..."
        
        # å¤åˆ¶æ‰€æœ‰æ’ä»¶çš„æž„å»ºæ–‡ä»¶åˆ°æ ¹ç›®å½•
        for plugin_dir in foxel-*/; do
          if [ -d "$plugin_dir" ] && [ -f "$plugin_dir/dist/plugin.js" ]; then
            plugin_name=$(basename "$plugin_dir")
            echo "ðŸ“‹ Copying $plugin_name/dist/plugin.js to root as $plugin_name.js"
            cp "$plugin_dir/dist/plugin.js" "$plugin_name.js"
          fi
        done

        echo "âœ… Root plugin files updated"

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add foxel-*.js
        git commit -m "chore(foxel-plugins): æ›´æ–°æ ¹ç›®å½•æ’ä»¶æ–‡ä»¶ ${{ inputs.version }}" || exit 0
        git push
