name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update plugin version
      run: |
        echo "ðŸ“¦ Updating plugin version to ${{ inputs.version }}"
        
        # æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
        VERSION="${{ inputs.version }}"
        if [[ $VERSION == v* ]]; then
          VERSION=${VERSION#v}
        fi
        
        echo "ðŸ“ Version: $VERSION"
        
        # æ›´æ–°æ‰€æœ‰æ’ä»¶çš„ package.json
        for plugin_dir in foxel-*/; do
          if [ -d "$plugin_dir" ] && [ -f "$plugin_dir/package.json" ]; then
            echo "ðŸ”„ Updating $plugin_dir package.json"
            cd "$plugin_dir"
            
            # ä½¿ç”¨ npm version å‘½ä»¤æ›´æ–°ç‰ˆæœ¬å·
            npm version "$VERSION" --no-git-tag-version
            
            echo "âœ… Updated $plugin_dir to version $VERSION"
            cd ..
          fi
        done
        
    - name: Build plugin
      run: |
        cd foxel-image-viewer
        npm ci
        npm run build
        
    - name: Prepare release files
      run: |
        mkdir -p release
        cp foxel-image-viewer/dist/plugin.js release/foxel-image-viewer.js
        
        # Create release notes
        cat > release/RELEASE_NOTES.md << 'EOF'
        # ðŸŽ‰ Foxel Plus å‘å¸ƒè¯´æ˜Ž
        
        ## ðŸ“¦ åŒ…å«çš„æ’ä»¶
        
        ### ðŸ–¼ï¸ foxel-image-viewer (v1.0.0)
        
        **æè¿°**: ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶ï¼Œæ”¯æŒç¼©æ”¾ã€æ‹–æ‹½ã€æ—‹è½¬ç­‰æ“ä½œ
        **æ–‡ä»¶å¤§å°**: $(du -h release/foxel-image-viewer.js | cut -f1)
        **æ”¯æŒæ ¼å¼**: JPG, PNG, GIF, BMP, WebP, SVG, ICO, TIFF
        
        #### ä¸»è¦åŠŸèƒ½
        - ðŸ” æ™ºèƒ½ç¼©æ”¾ï¼ˆ10%-500%ï¼‰
        - ðŸ–±ï¸ æ‹–æ‹½ç§»åŠ¨
        - ðŸŽ›ï¸ å·¥å…·æ æŽ§åˆ¶
        - ðŸŒ™ æ·±è‰²ä¸»é¢˜
        - ðŸ“± å“åº”å¼è®¾è®¡
        
        #### å®‰è£…æ–¹æ³•
        1. ä¸‹è½½ \`foxel-image-viewer.js\` æ–‡ä»¶
        2. å°†æ–‡ä»¶å¤åˆ¶åˆ° Foxel çš„ \`web/public/plugins/\` ç›®å½•
        3. åœ¨ Foxel çš„"åº”ç”¨"é¡µé¢å®‰è£…æ’ä»¶
        4. é€‰æ‹©å¯¹åº”æ–‡ä»¶ç±»åž‹å³å¯ä½¿ç”¨
        
        #### æŠ€æœ¯ç‰¹æ€§
        - **å®Œå…¨è‡ªåŒ…å«** - å•æ–‡ä»¶è¾“å‡ºï¼Œæ— å¤–éƒ¨ä¾èµ–
        - **ç±»åž‹å®‰å…¨** - åŸºäºŽ TypeScript å¼€å‘
        - **çŽ°ä»£åŒ– UI** - ä½¿ç”¨ React 18 æž„å»º
        - **é«˜æ€§èƒ½** - ESBuild ä¼˜åŒ–æž„å»º
        - **å³æ’å³ç”¨** - ç¬¦åˆ Foxel æ’ä»¶è§„èŒƒ
        EOF
        
        echo "ðŸ“‹ Release files prepared:"
        ls -la release/
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.version }}
        name: Foxel Image Viewer ${{ inputs.version }}
        files: |
          release/foxel-image-viewer.js
          release/RELEASE_NOTES.md
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: ${{ inputs.prerelease }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
