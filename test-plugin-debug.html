<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foxel æ’ä»¶è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }
        .log {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005a9e;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #2e7d32; }
        .error { background-color: #d32f2f; }
        .warning { background-color: #f57c00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Foxel æ’ä»¶è°ƒè¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h2>1. æ£€æŸ¥ Foxel ç¯å¢ƒ</h2>
            <button onclick="checkFoxelEnvironment()">æ£€æŸ¥ Foxel ç¯å¢ƒ</button>
            <div id="foxel-status" class="status"></div>
            <div id="foxel-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>2. åŠ è½½æ’ä»¶æ–‡ä»¶</h2>
            <button onclick="loadPlugin()">åŠ è½½å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶</button>
            <button onclick="loadSimplePlugin()">åŠ è½½ç®€å•æµ‹è¯•æ’ä»¶</button>
            <div id="plugin-status" class="status"></div>
            <div id="plugin-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>3. æ£€æŸ¥æ’ä»¶æ³¨å†Œ</h2>
            <button onclick="checkPluginRegistration()">æ£€æŸ¥æ’ä»¶æ³¨å†Œ</button>
            <div id="registration-status" class="status"></div>
            <div id="registration-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>4. æµ‹è¯•æ’ä»¶åŠŸèƒ½</h2>
            <button onclick="testPluginFunction()">æµ‹è¯•æ’ä»¶åŠŸèƒ½</button>
            <div id="function-status" class="status"></div>
            <div id="function-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>5. æ§åˆ¶å°æ—¥å¿—</h2>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="console-log" class="log"></div>
        </div>
    </div>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logMessage);
            console.log(logMessage);
            updateConsoleLog();
        }

        function updateConsoleLog() {
            const consoleLog = document.getElementById('console-log');
            consoleLog.textContent = logs.join('\n');
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function setLog(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
        }

        function checkFoxelEnvironment() {
            log('å¼€å§‹æ£€æŸ¥ Foxel ç¯å¢ƒ...');
            
            // æ£€æŸ¥ window å¯¹è±¡
            if (typeof window === 'undefined') {
                setStatus('foxel-status', 'âŒ window å¯¹è±¡æœªå®šä¹‰', 'error');
                setLog('foxel-log', 'window å¯¹è±¡æœªå®šä¹‰ï¼Œæ— æ³•è¿è¡Œæ’ä»¶');
                return;
            }
            log('âœ… window å¯¹è±¡å­˜åœ¨');

            // æ£€æŸ¥ FoxelRegister å‡½æ•°
            if (typeof window.FoxelRegister === 'function') {
                setStatus('foxel-status', 'âœ… FoxelRegister å‡½æ•°å­˜åœ¨', 'success');
                setLog('foxel-log', 'FoxelRegister å‡½æ•°å·²æ‰¾åˆ°ï¼Œç‰ˆæœ¬: ' + (window.FoxelRegister.version || 'æœªçŸ¥'));
                log('FoxelRegister å‡½æ•°å­˜åœ¨');
            } else {
                setStatus('foxel-status', 'âŒ FoxelRegister å‡½æ•°ä¸å­˜åœ¨', 'error');
                setLog('foxel-log', 'FoxelRegister å‡½æ•°æœªæ‰¾åˆ°ï¼Œæ’ä»¶æ— æ³•æ³¨å†Œ');
                log('FoxelRegister å‡½æ•°ä¸å­˜åœ¨');
            }

            // æ£€æŸ¥å…¶ä»– Foxel ç›¸å…³å¯¹è±¡
            const foxelObjects = ['Foxel', 'foxel', 'FoxelHost'];
            let foundObjects = [];
            foxelObjects.forEach(obj => {
                if (window[obj]) {
                    foundObjects.push(obj);
                }
            });

            if (foundObjects.length > 0) {
                log('æ‰¾åˆ° Foxel ç›¸å…³å¯¹è±¡: ' + foundObjects.join(', '));
                setLog('foxel-log', document.getElementById('foxel-log').textContent + '\n\næ‰¾åˆ° Foxel ç›¸å…³å¯¹è±¡: ' + foundObjects.join(', '));
            }
        }

        function loadPlugin() {
            log('å¼€å§‹åŠ è½½å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶æ–‡ä»¶...');
            
            const script = document.createElement('script');
            script.src = './foxel-image-viewer.js';
            script.onload = function() {
                setStatus('plugin-status', 'âœ… å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶æ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
                setLog('plugin-log', 'å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶æ–‡ä»¶å·²æˆåŠŸåŠ è½½');
                log('å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶æ–‡ä»¶åŠ è½½æˆåŠŸ');
            };
            script.onerror = function() {
                setStatus('plugin-status', 'âŒ å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶æ–‡ä»¶åŠ è½½å¤±è´¥', 'error');
                setLog('plugin-log', 'æ— æ³•åŠ è½½å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
                log('å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶æ–‡ä»¶åŠ è½½å¤±è´¥');
            };
            document.head.appendChild(script);
        }

        function loadSimplePlugin() {
            log('å¼€å§‹åŠ è½½ç®€å•æµ‹è¯•æ’ä»¶æ–‡ä»¶...');
            
            const script = document.createElement('script');
            script.src = './simple-test-plugin.js';
            script.onload = function() {
                setStatus('plugin-status', 'âœ… ç®€å•æµ‹è¯•æ’ä»¶æ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
                setLog('plugin-log', 'ç®€å•æµ‹è¯•æ’ä»¶æ–‡ä»¶å·²æˆåŠŸåŠ è½½');
                log('ç®€å•æµ‹è¯•æ’ä»¶æ–‡ä»¶åŠ è½½æˆåŠŸ');
            };
            script.onerror = function() {
                setStatus('plugin-status', 'âŒ ç®€å•æµ‹è¯•æ’ä»¶æ–‡ä»¶åŠ è½½å¤±è´¥', 'error');
                setLog('plugin-log', 'æ— æ³•åŠ è½½ç®€å•æµ‹è¯•æ’ä»¶æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
                log('ç®€å•æµ‹è¯•æ’ä»¶æ–‡ä»¶åŠ è½½å¤±è´¥');
            };
            document.head.appendChild(script);
        }

        function checkPluginRegistration() {
            log('å¼€å§‹æ£€æŸ¥æ’ä»¶æ³¨å†Œ...');
            
            // æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²æ³¨å†Œ
            if (window.FoxelRegister) {
                // å°è¯•è·å–å·²æ³¨å†Œçš„æ’ä»¶åˆ—è¡¨
                if (window.FoxelRegister.plugins) {
                    const plugins = window.FoxelRegister.plugins;
                    setStatus('registration-status', `âœ… æ‰¾åˆ° ${plugins.length} ä¸ªå·²æ³¨å†Œæ’ä»¶`, 'success');
                    setLog('registration-log', 'å·²æ³¨å†Œçš„æ’ä»¶:\n' + plugins.map(p => `- ${p.name} (${p.key})`).join('\n'));
                    log(`æ‰¾åˆ° ${plugins.length} ä¸ªå·²æ³¨å†Œæ’ä»¶`);
                } else {
                    setStatus('registration-status', 'âš ï¸ FoxelRegister å­˜åœ¨ä½†æ— æ³•è·å–æ’ä»¶åˆ—è¡¨', 'warning');
                    setLog('registration-log', 'FoxelRegister å‡½æ•°å­˜åœ¨ï¼Œä½†æ— æ³•è·å–å·²æ³¨å†Œçš„æ’ä»¶åˆ—è¡¨');
                    log('æ— æ³•è·å–æ’ä»¶åˆ—è¡¨');
                }
            } else {
                setStatus('registration-status', 'âŒ FoxelRegister ä¸å­˜åœ¨', 'error');
                setLog('registration-log', 'FoxelRegister å‡½æ•°ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥æ’ä»¶æ³¨å†Œ');
                log('FoxelRegister ä¸å­˜åœ¨');
            }
        }

        function testPluginFunction() {
            log('å¼€å§‹æµ‹è¯•æ’ä»¶åŠŸèƒ½...');
            
            // æ¨¡æ‹Ÿæ’ä»¶ä¸Šä¸‹æ–‡
            const mockCtx = {
                filePath: 'test.jpg',
                entry: { name: 'test.jpg' },
                urls: { downloadUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiM0NDQiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTkgMTJMMTEgMTRMMTUgMTBMMjEgMTZWMThIM1YxNkw5IDEyWiIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+' },
                host: { close: () => console.log('å…³é—­æ’ä»¶') }
            };

            // åˆ›å»ºæµ‹è¯•å®¹å™¨
            const testContainer = document.createElement('div');
            testContainer.id = 'test-plugin-container';
            testContainer.style.cssText = 'width: 400px; height: 300px; border: 1px solid #333; margin: 20px 0;';
            document.body.appendChild(testContainer);

            // æ£€æŸ¥æ’ä»¶
            if (window.FoxelRegister && window.FoxelRegister.plugins) {
                const plugins = window.FoxelRegister.plugins;
                const imageViewerPlugin = plugins.find(p => p.key === 'com.foxel-plus.image-viewer');
                const simpleTestPlugin = plugins.find(p => p.key === 'com.foxel-plus.simple-test');
                
                let foundPlugin = null;
                let pluginName = '';
                
                if (imageViewerPlugin) {
                    foundPlugin = imageViewerPlugin;
                    pluginName = 'å›¾ç‰‡æŸ¥çœ‹å™¨æ’ä»¶';
                } else if (simpleTestPlugin) {
                    foundPlugin = simpleTestPlugin;
                    pluginName = 'ç®€å•æµ‹è¯•æ’ä»¶';
                }
                
                if (foundPlugin) {
                    setStatus('function-status', `âœ… æ‰¾åˆ°${pluginName}`, 'success');
                    setLog('function-log', `æ’ä»¶ä¿¡æ¯:\n${JSON.stringify(foundPlugin, null, 2)}`);
                    log(`æ‰¾åˆ°${pluginName}`);
                    
                    // å°è¯•æŒ‚è½½æ’ä»¶
                    try {
                        foundPlugin.mount(testContainer, mockCtx);
                        setLog('function-log', document.getElementById('function-log').textContent + '\n\nâœ… æ’ä»¶æŒ‚è½½æˆåŠŸ');
                        log('æ’ä»¶æŒ‚è½½æˆåŠŸ');
                    } catch (error) {
                        setLog('function-log', document.getElementById('function-log').textContent + '\n\nâŒ æ’ä»¶æŒ‚è½½å¤±è´¥: ' + error.message);
                        log('æ’ä»¶æŒ‚è½½å¤±è´¥: ' + error.message);
                    }
                } else {
                    setStatus('function-status', 'âŒ æœªæ‰¾åˆ°ä»»ä½•æ’ä»¶', 'error');
                    setLog('function-log', `åœ¨å·²æ³¨å†Œçš„æ’ä»¶ä¸­æœªæ‰¾åˆ°ç›®æ ‡æ’ä»¶ã€‚\nå·²æ³¨å†Œçš„æ’ä»¶: ${plugins.map(p => p.key).join(', ')}`);
                    log('æœªæ‰¾åˆ°ç›®æ ‡æ’ä»¶');
                }
            } else {
                setStatus('function-status', 'âŒ æ— æ³•æ£€æŸ¥æ’ä»¶', 'error');
                setLog('function-log', 'æ— æ³•è·å–æ’ä»¶åˆ—è¡¨');
                log('æ— æ³•æ£€æŸ¥æ’ä»¶');
            }
        }

        function clearLogs() {
            logs = [];
            updateConsoleLog();
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            checkFoxelEnvironment();
        });
    </script>
</body>
</html>
